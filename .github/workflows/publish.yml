name: CI Publish

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version (e.g. 1.0.0)'
        required: true
        type: string
  push:
    tags:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  # --- JOB 1: Create Tag (Runs ONLY on manual trigger) ---
  create_release_tag:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.RELEASE_TOKEN }}        

      - name: Create and Push Tag
        run: |
          VERSION="${{ inputs.version }}"
          if [[ $VERSION != v* ]]; then VERSION="v$VERSION"; fi
          
          echo "Preparing to tag commit with: $VERSION"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

  # --- JOB 2: Build Custom JREs (Desktop Dependency) ---
  jlink:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: linux-amd64
          - os: ubuntu-24.04-arm
            name: linux-arm64
          - os: windows-latest
            name: windows-x64
          - os: macos-15
            name: macOS-arm64
          - os: macos-15-intel
            name: macOS-x64
    steps:
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu'

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Package JDK
        run: make jlink

      - name: Upload JDK package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-jre
          path: jre_bundle

  # --- JOB 3: Build WebUI (Desktop Dependency) ---
  build_webui:
    name: Build WebUI (Desktop)
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Set up NodeJs
        uses: actions/setup-node@v4
        with:
          node-version-file: 'Mangatan-WebUI/package.json'
          cache: 'yarn'
          cache-dependency-path: 'Mangatan-WebUI/yarn.lock'
      - name: Build WebUI Assets
        run: |
          cd Mangatan-WebUI
          yarn install --frozen-lockfile
          yarn build
      - name: Upload WebUI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: webui-assets
          path: Mangatan-WebUI/build 

  # --- JOB 4: Build Mangatan Launcher (Desktop) ---
  build_mangatan:
    name: Build Mangatan Desktop (${{ matrix.name }})
    needs: [jlink, build_webui]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux-amd64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            arch_name: linux-amd64
            jogamp_target: linux-amd64
          - name: Linux-arm64
            os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            arch_name: linux-arm64
            jogamp_target: linux-aarch64
          - name: Windows-x64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            arch_name: windows-x64
            jogamp_target: windows-amd64
          - name: macOS-Intel
            os: macos-15-intel
            target: x86_64-apple-darwin
            arch_name: macOS-x64
            jogamp_target: macosx-universal
          - name: macOS-Silicon
            os: macos-15
            target: aarch64-apple-darwin
            arch_name: macOS-arm64
            jogamp_target: macosx-universal

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Install NASM
        if: runner.os == 'Windows' || runner.os == 'macOS'
        uses: ilammy/setup-nasm@v1

      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-dev libgtk-3-dev libappindicator3-dev librsvg2-dev libxdo-dev fuse p7zip-full nasm

      - name: Install macOS Dependencies
        if: runner.os == 'macOS'
        run: brew install p7zip

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Create Resources Directory
        shell: bash
        run: mkdir -p bin/mangatan/resources

      - name: Prepare JogAmp Natives
        shell: bash
        run: |
          curl -L "https://github.com/KolbyML/jogamp/releases/download/1/jogamp-all-platforms.7z" -o jogamp.7z
          7z x jogamp.7z "jogamp-all-platforms/lib/${{ matrix.jogamp_target }}"
          mkdir natives_temp && mv jogamp-all-platforms/lib/${{ matrix.jogamp_target }} natives_temp/
          cd natives_temp
          if [ "${{ runner.os }}" == "Windows" ]; then
            7z a -tzip ../bin/mangatan/resources/natives.zip ${{ matrix.jogamp_target }}
          else
            zip -r ../bin/mangatan/resources/natives.zip ${{ matrix.jogamp_target }}
          fi

      - name: Download JRE
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.arch_name }}-jre
          path: temp_jre
      
      - name: Zip JRE for Embedding
        shell: bash
        run: |
          cd temp_jre
          if [ "${{ runner.os }}" == "Windows" ]; then
            7z a -tzip ../bin/mangatan/resources/jre_bundle.zip *
          else
            zip -r ../bin/mangatan/resources/jre_bundle.zip .
          fi

      - name: Download Suwayomi JAR
        shell: bash
        run: make download_jar
      
      - name: Download WebUI Assets
        uses: actions/download-artifact@v4
        with:
          name: webui-assets
          path: bin/mangatan/resources/mangatan-webui

      - name: Build Binary
        shell: bash
        env:
          CARGO_TARGET_DIR: ${{ github.workspace }}/target
        run: |
          cd bin/mangatan
          cargo build --release --target ${{ matrix.target }} --features embed-jre

      - name: Package Windows
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir output
          cp "${{ github.workspace }}/target/${{ matrix.target }}/release/mangatan.exe" output/
          cd output && 7z a -tzip ../mangatan-windows-x64.zip * && cd ..
          mkdir final_artifact && mv mangatan-windows-x64.zip final_artifact/

      - name: Package Linux
        if: runner.os == 'Linux'
        shell: bash
        run: |
          BINARY_PATH="${{ github.workspace }}/target/${{ matrix.target }}/release/mangatan"
          ICON_PATH="bin/mangatan/resources/faviconlogo.png"
          VERSION="${{ github.ref_name }}"
          CLEAN_VERSION=$(echo $VERSION | sed 's/^v//')
          
          DEB_ARCH="amd64"
          if [[ "${{ matrix.target }}" == *"aarch64"* ]]; then
            DEB_ARCH="arm64"
          fi
          
          mkdir -p output
          
          # --- 1. BUILD DEB (SHIM STRATEGY) ---
          mkdir -p deb_pkg/usr/lib/mangatan
          mkdir -p deb_pkg/usr/bin
          mkdir -p deb_pkg/usr/share/applications 
          mkdir -p deb_pkg/usr/share/icons/hicolor/512x512/apps 
          mkdir -p deb_pkg/DEBIAN
          
          # 1. Place the REAL binary in /usr/lib (System Read-Only Location)
          cp "$BINARY_PATH" deb_pkg/usr/lib/mangatan/mangatan-server
          
          # 2. Create the WRAPPER SCRIPT
          # This script copies the binary to user's data dir/bin if missing or if system has update
          cat > deb_pkg/usr/bin/mangatan <<'EOF'
          #!/bin/bash
          set -e
          
          # Define paths
          SYSTEM_BIN="/usr/lib/mangatan/mangatan-server"
          USER_DIR="$HOME/.local/share/mangatan/bin"
          USER_BIN="$USER_DIR/mangatan"
          
          # Ensure user directory exists
          mkdir -p "$USER_DIR"
          
          # Copy logic:
          # - If user bin doesn't exist, copy it.
          # - If system bin is NEWER (e.g. user updated via apt), overwrite user bin.
          if [ -f "$SYSTEM_BIN" ]; then
              cp -u "$SYSTEM_BIN" "$USER_BIN"
          fi
          
          chmod +x "$USER_BIN"
          
          # Run the USER copy (which is writable and self-updatable)
          exec "$USER_BIN" "$@"
          EOF
          
          # Make the wrapper executable
          chmod +x deb_pkg/usr/bin/mangatan
          
          # 3. Copy Icon & Control File
          cp "$ICON_PATH" deb_pkg/usr/share/icons/hicolor/512x512/apps/mangatan.png
          
          cat > deb_pkg/DEBIAN/control <<EOF
          Package: mangatan
          Version: $CLEAN_VERSION
          Section: utils
          Priority: optional
          Architecture: $DEB_ARCH
          Maintainer: Mangatan Team
          Description: Mangatan Server
           A robust manga server application.
          EOF
          
          cat > deb_pkg/usr/share/applications/mangatan.desktop <<EOF
          [Desktop Entry]
          Name=Mangatan
          Exec=/usr/bin/mangatan
          Icon=mangatan
          Type=Application
          Categories=Utility;
          Terminal=false
          EOF
          
          dpkg-deb --build deb_pkg output/mangatan_${CLEAN_VERSION}_${DEB_ARCH}.deb

          # --- 2. BUILD TAR.GZ (FLAT STRUCTURE) ---
          # This remains flat so the self-updater can find the binary easily
          mkdir -p tar_staging
          cp "$BINARY_PATH" tar_staging/mangatan
          chmod +x tar_staging/mangatan
          
          cd tar_staging
          tar -czvf ../output/mangatan-${{ matrix.arch_name }}.tar.gz mangatan
          cd ..

      - name: Package macOS
        if: runner.os == 'macOS'
        shell: bash
        run: |
          mkdir output
          cp "${{ github.workspace }}/target/${{ matrix.target }}/release/mangatan" output/
          cd output && zip mangatan-macos.zip mangatan

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        if: runner.os == 'Windows'
        with:
          name: mangatan-${{ matrix.arch_name }}
          path: final_artifact/mangatan-windows-x64.zip

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        if: runner.os == 'Linux'
        with:
          name: mangatan-${{ matrix.arch_name }}
          path: output/*

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        if: runner.os == 'macOS'
        with:
          name: mangatan-${{ matrix.arch_name }}
          path: output/mangatan-macos.zip

  # --- JOB 5: Build Android APK (Integrated) ---
  build_android:
    if: startsWith(github.ref, 'refs/tags/v')
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android Platform & NDK
        run: |
          yes | sdkmanager --licenses
          sdkmanager "platforms;android-30" "platforms;android-26" "build-tools;30.0.3" "ndk;26.1.10909125"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android, armv7-linux-androideabi

      - name: Install cargo-apk2
        run: cargo install --git https://github.com/kolbyml/cargo-apk2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
          cache: 'yarn'
          cache-dependency-path: 'Mangatan-WebUI/yarn.lock'

      - name: Prepare Assets (WebUI & Jars)
        run: |
          make android_webui
          make download_android_jar
          make download_android_jre

      - name: Setup App Icon
        run: |
          mkdir -p bin/mangatan_android/res/mipmap-xxxhdpi
          mkdir -p bin/mangatan_android/res/mipmap-xxhdpi
          mkdir -p bin/mangatan_android/res/mipmap-xhdpi
          mkdir -p bin/mangatan_android/res/mipmap-hdpi
          mkdir -p bin/mangatan_android/res/mipmap-mdpi
          cp bin/mangatan/resources/faviconlogo.png bin/mangatan_android/res/mipmap-xxxhdpi/ic_launcher.png
          cp bin/mangatan/resources/faviconlogo.png bin/mangatan_android/res/mipmap-xxhdpi/ic_launcher.png
          cp bin/mangatan/resources/faviconlogo.png bin/mangatan_android/res/mipmap-xhdpi/ic_launcher.png
          cp bin/mangatan/resources/faviconlogo.png bin/mangatan_android/res/mipmap-hdpi/ic_launcher.png
          cp bin/mangatan/resources/faviconlogo.png bin/mangatan_android/res/mipmap-mdpi/ic_launcher.png

      - name: Configure Dummy Keystore
        working-directory: bin/mangatan_android
        run: |
          keytool -genkey -v -keystore dummy.keystore -alias dummy -keyalg RSA -keysize 2048 -validity 10000 -storepass password -keypass password -dname "CN=Dummy,O=Dummy,C=US"
          
          cat >> Cargo.toml <<EOF
          
          [package.metadata.android.signing.release]
          path = "dummy.keystore"
          keystore_password = "password"
          key_alias = "dummy"
          key_password = "password"
          EOF

      - name: Build APK
        working-directory: bin/mangatan_android
        run: |
          NDK_ROOT=${ANDROID_NDK_HOME}
          if [ -z "$NDK_ROOT" ]; then
            NDK_ROOT=$(ls -d /usr/local/lib/android/sdk/ndk/* | sort -V | tail -n1)
          fi
          echo "Using NDK at: $NDK_ROOT"

          TOOLCHAIN_BIN="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"

          export RANLIB="$TOOLCHAIN_BIN/llvm-ranlib"
          export AR="$TOOLCHAIN_BIN/llvm-ar"
          
          # --- CONFIG FOR AARCH64 (64-bit) ---
          # We use target-specific env vars so cc-rs can find the right compiler for each arch
          export CC_aarch64_linux_android="$TOOLCHAIN_BIN/aarch64-linux-android30-clang"
          export CXX_aarch64_linux_android="$TOOLCHAIN_BIN/aarch64-linux-android30-clang++"
          export AR_aarch64_linux_android="$TOOLCHAIN_BIN/llvm-ar"
          
          # --- CONFIG FOR ARMV7 (32-bit) ---
          # Note the 'armv7a' prefix in the clang executable name
          export CC_armv7_linux_androideabi="$TOOLCHAIN_BIN/armv7a-linux-androideabi30-clang"
          export CXX_armv7_linux_androideabi="$TOOLCHAIN_BIN/armv7a-linux-androideabi30-clang++"
          export AR_armv7_linux_androideabi="$TOOLCHAIN_BIN/llvm-ar"

          cargo apk2 build --release

      - name: Locate and Stage APK
        run: |
          echo "ðŸ” Searching for APK..."
          # Find the APK in the 'target' directory (ignoring intermediates)
          APK_PATH=$(find target -name "*.apk" | grep "release" | head -n 1)
          
          if [ -z "$APK_PATH" ]; then
            echo "âŒ Error: Could not find any APK in 'target/'"
            find target -name "*.apk" || echo "No APKs found at all."
            exit 1
          fi
          
          echo "âœ… Found APK at: $APK_PATH"
          
          # Create a clean directory for the signer
          mkdir -p signing_stage
          cp "$APK_PATH" signing_stage/mangatan-unsigned.apk
          echo "âœ… Copied to signing_stage/mangatan-unsigned.apk"

      - name: Sign APK Manually
        env:
          SIGNING_KEY_BASE64: ${{ secrets.ANDROID_SIGNING_KEY }}
          KEY_STORE_PASSWORD: ${{ secrets.ANDROID_KEY_STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ALIAS: mangatan
        run: |
          echo "ðŸ” Decoding Keystore..."
          echo "$SIGNING_KEY_BASE64" | base64 -d --ignore-garbage > release.keystore

          # Check keystore validity
          keytool -list -keystore release.keystore -storepass "$KEY_STORE_PASSWORD" -alias "$ALIAS" || {
             echo "âŒ ERROR: Keystore is corrupt or password is wrong."
             exit 1
          }
          
          BUILD_TOOLS_PATH="$ANDROID_HOME/build-tools/30.0.3"
          
          echo "ðŸ“ Aligning APK..."
          "$BUILD_TOOLS_PATH/zipalign" -v -p 4 signing_stage/mangatan-unsigned.apk mangatan-aligned.apk
          
          echo "âœï¸ Signing APK..."
          "$BUILD_TOOLS_PATH/apksigner" sign \
            --ks release.keystore \
            --ks-pass pass:"$KEY_STORE_PASSWORD" \
            --ks-key-alias "$ALIAS" \
            --key-pass pass:"$KEY_PASSWORD" \
            --out mangatan-android-signed.apk \
            mangatan-aligned.apk
            
          "$BUILD_TOOLS_PATH/apksigner" verify mangatan-android-signed.apk

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mangatan-android
          path: mangatan-android-signed.apk

  build_ios:
    name: Build iOS IPA
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
          cache: 'yarn'
          cache-dependency-path: 'Mangatan-WebUI/yarn.lock'

      # 1. Install Rust with iOS Target
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      # 2. Patch Xcode Project to preserve SDKROOT
      # The 'unset SDKROOT' in your Run Script phase breaks 'ring' compilation in CI.
      # This command comments it out so the build inherits the iOS SDK path.
      - name: Patch Xcode Project
        run: |
          echo "Patching project.pbxproj to preserve SDKROOT..."
          find bin/mangatan_ios -name "project.pbxproj" -exec sed -i '' 's/unset SDKROOT/# unset SDKROOT/g' {} +
          echo "Patch applied."

      - name: Prepare iOS Assets
        run: |
          make ios_webui
          make download_ios_jar
          make ios_jre
          make ios_framework          

      # 3. Pre-build Rust (Warms cache & ensures dependencies compile)
      - name: Pre-build Rust Backend
        run: |
          export SDKROOT=$(xcrun --sdk iphoneos --show-sdk-path)
          echo "Using SDKROOT: $SDKROOT"
          cd bin/mangatan_ios/backend
          cargo build --release --target aarch64-apple-ios

      - name: Build IPA
        run: |
          cd bin/mangatan_ios
          
          # 1. Build Archive
          xcodebuild -scheme Mangatan \
            -destination "generic/platform=iOS" \
            -archivePath Mangatan.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

          # 2. Export IPA
          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>development</string>
              <key>signingStyle</key>
              <string>manual</string>
          </dict>
          </plist>
          EOF
          
          mkdir -p Payload
          cp -r Mangatan.xcarchive/Products/Applications/Mangatan.app Payload/
          zip -r Mangatan.ipa Payload
          
      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mangatan-ios
          path: bin/mangatan_ios/Mangatan.ipa

      
  # --- JOB 6: Release (Combines Everything) ---
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build_mangatan, build_android, build_ios]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  

      # Download Desktop Artifacts
      - name: Download Linux AMD64
        uses: actions/download-artifact@v4
        with:
          name: mangatan-linux-amd64
          path: release/linux-amd64
      - name: Download Linux ARM64
        uses: actions/download-artifact@v4
        with:
          name: mangatan-linux-arm64
          path: release/linux-arm64
      - name: Download Windows
        uses: actions/download-artifact@v4
        with:
          name: mangatan-windows-x64
          path: release/windows
      - name: Download Mac Intel
        uses: actions/download-artifact@v4
        with:
          name: mangatan-macOS-x64
          path: release/mac-intel
      - name: Download Mac Silicon
        uses: actions/download-artifact@v4
        with:
          name: mangatan-macOS-arm64
          path: release/mac-silicon

      - name: Download Android
        uses: actions/download-artifact@v4
        with:
          name: mangatan-android
          path: release/android

      - name: Download iOS
        uses: actions/download-artifact@v4
        with:
          name: mangatan-ios
          path: release/ios

      - name: Prepare Final Assets
        run: |
          mkdir final_release
          VERSION=${{ github.ref_name }}
          
          # DESKTOP
          mv release/windows/mangatan-windows-x64.zip final_release/Mangatan-${VERSION}-Windows-x64.zip
          mv release/linux-amd64/*.deb final_release/Mangatan-${VERSION}-Linux-amd64.deb || true
          mv release/linux-amd64/*.tar.gz final_release/Mangatan-${VERSION}-Linux-amd64.tar.gz || true
          mv release/linux-arm64/*.deb final_release/Mangatan-${VERSION}-Linux-arm64.deb || true
          mv release/linux-arm64/*.tar.gz final_release/Mangatan-${VERSION}-Linux-arm64.tar.gz || true
          mv release/mac-intel/mangatan-macos.zip final_release/Mangatan-${VERSION}-macOS-Intel.zip
          mv release/mac-silicon/mangatan-macos.zip final_release/Mangatan-${VERSION}-macOS-Silicon.zip
          
          # ANDROID
          # Rename the raw signed APK to have the version number
          mv release/android/mangatan-android-signed.apk final_release/Mangatan-${VERSION}-Android.apk

          # iOS
          mv release/ios/Mangatan.ipa final_release/Mangatan-${VERSION}-iOS.ipa

      - name: Generate Checksums
        run: cd final_release && sha256sum * > Checksums.sha256

      - name: Generate Release Notes
        id: release_notes
        run: |
          CURRENT_TAG=${{ github.ref_name }}
          PREV_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || true)
          echo "## Release $CURRENT_TAG" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          if [ -z "$PREV_TAG" ]; then
            git log --no-merges --pretty=format:"- %s (%h)" >> RELEASE_NOTES.md
          else
            git log "$PREV_TAG..$CURRENT_TAG" --no-merges --pretty=format:"- %s (%h)" >> RELEASE_NOTES.md
          fi

      - name: Load Release Notes
        run: |
          echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
          cat RELEASE_NOTES.md >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV 
          echo "EOF" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          body_path: RELEASE_NOTES.md
          files: final_release/*

      - name: Notify Discord
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            ðŸš€ **New Release Published!**
            
            **Version:** ${{ github.ref_name }}
            **Download:** https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}
            
            **Changelog:**
            ${{ env.RELEASE_BODY }}
