name: CI Publish

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --- JOB 2: Build Custom JREs ---
  jlink:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: linux-x64
          - os: ubuntu-24.04-arm
            name: linux-arm64
          - os: windows-latest
            name: windows-x64
          - os: macos-15
            name: macOS-arm64
          - os: macos-15-intel
            name: macOS-x64
    steps:
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu'

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Package JDK
        run: make jlink

      - name: Upload JDK package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-jre
          path: jre_bundle

  # --- JOB 3: Build WebUI ---
  build_webui:
    name: Build WebUI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Set up NodeJs
        uses: actions/setup-node@v4
        with:
          node-version-file: 'Suwayomi-WebUI/package.json'
          cache: 'yarn'
          cache-dependency-path: 'Suwayomi-WebUI/yarn.lock'
      - name: Build WebUI Assets
        run: |
          cd Suwayomi-WebUI
          yarn install --frozen-lockfile
          yarn build
      - name: Upload WebUI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: webui-assets
          path: Suwayomi-WebUI/build 

  # --- JOB 4: Build Mangatan Launcher & Bundling ---
  build_mangatan:
    name: Build Mangatan (${{ matrix.name }})
    needs: [jlink, build_webui]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- LINUX x64 ---
          - name: Linux-x64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            arch_name: linux-x64
            jogamp_target: linux-amd64

          # --- LINUX ARM64 ---
          - name: Linux-arm64
            os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            arch_name: linux-arm64
            jogamp_target: linux-aarch64
            
          # --- WINDOWS ---
          - name: Windows-x64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            arch_name: windows-x64
            jogamp_target: windows-amd64
            
          # --- MACOS ---
          - name: macOS-Intel
            os: macos-15-intel
            target: x86_64-apple-darwin
            arch_name: macOS-x64
            jogamp_target: macosx-universal
            
          - name: macOS-Silicon
            os: macos-15
            target: aarch64-apple-darwin
            arch_name: macOS-arm64
            jogamp_target: macosx-universal

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- LINUX DEPENDENCIES (Runs on both x64 and ARM64 now) ---
      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-dev libgtk-3-dev libappindicator3-dev librsvg2-dev libxdo-dev fuse p7zip-full

      - name: Install macOS Dependencies
        if: runner.os == 'macOS'
        run: brew install p7zip

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # --- ASSET PREPARATION ---
      - name: Create Resources Directory
        shell: bash
        run: mkdir -p bin/mangatan/resources

      - name: Prepare JogAmp Natives
        shell: bash
        run: |
          curl -L "https://jogamp.org/deployment/jogamp-current/archive/jogamp-all-platforms.7z" -o jogamp.7z
          
          # Extract the specific target folder
          7z x jogamp.7z "jogamp-all-platforms/lib/${{ matrix.jogamp_target }}"
          
          mkdir natives_temp
          
          # Move the entire architecture folder (e.g., 'linux-amd64') into natives_temp
          mv jogamp-all-platforms/lib/${{ matrix.jogamp_target }} natives_temp/
          
          cd natives_temp
          
          # Zip the folder itself (so the zip contains 'linux-amd64/libgluegen.so')
          if [ "${{ runner.os }}" == "Windows" ]; then
            7z a -tzip ../bin/mangatan/resources/natives.zip ${{ matrix.jogamp_target }}
          else
            zip -r ../bin/mangatan/resources/natives.zip ${{ matrix.jogamp_target }}
          fi

      - name: Download JRE
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.arch_name }}-jre
          path: temp_jre

      - name: Zip JRE for Embedding
        shell: bash
        run: |
          cd temp_jre
          if [ "${{ runner.os }}" == "Windows" ]; then
            7z a -tzip ../bin/mangatan/resources/jre_bundle.zip *
          else
            zip -r ../bin/mangatan/resources/jre_bundle.zip .
          fi

      - name: Download Suwayomi JAR
        shell: bash
        run: make download_jar

      - name: Download WebUI Assets
        uses: actions/download-artifact@v4
        with:
          name: webui-assets
          path: bin/mangatan/resources/suwayomi-webui

      # --- COMPILATION (Native for everyone) ---
      - name: Build Binary
        shell: bash
        env:
          CARGO_TARGET_DIR: ${{ github.workspace }}/target
        run: |
          cd bin/mangatan
          cargo build --release --target ${{ matrix.target }} --features embed-jre

      # --- WINDOWS PACKAGING ---
      - name: Package Windows
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir output
          cp target/${{ matrix.target }}/release/mangatan.exe output/
          cd output && 7z a -tzip ../mangatan-windows-x64.zip * && cd ..
          mkdir final_artifact && mv mangatan-windows-x64.zip final_artifact/

      # --- LINUX PACKAGING ---
      - name: Package Linux
        if: runner.os == 'Linux'
        shell: bash
        run: |
          BINARY_PATH="target/${{ matrix.target }}/release/mangatan"
          ICON_PATH="bin/mangatan/resources/faviconlogo.png"
          VERSION="${{ github.ref_name }}"
          CLEAN_VERSION=$(echo $VERSION | sed 's/^v//')
          
          # Detect Arch
          DEB_ARCH="amd64"
          if [[ "${{ matrix.target }}" == *"aarch64"* ]]; then
            DEB_ARCH="arm64"
          fi
          
          mkdir -p output
          
          # --- 1. BUILD DEB ---
          mkdir -p deb_pkg/usr/bin deb_pkg/usr/share/applications deb_pkg/usr/share/icons/hicolor/512x512/apps deb_pkg/DEBIAN
          cp "$BINARY_PATH" deb_pkg/usr/bin/mangatan
          cp "$ICON_PATH" deb_pkg/usr/share/icons/hicolor/512x512/apps/mangatan.png
          chmod +x deb_pkg/usr/bin/mangatan
          
          cat > deb_pkg/DEBIAN/control <<EOF
          Package: mangatan
          Version: $CLEAN_VERSION
          Section: utils
          Priority: optional
          Architecture: $DEB_ARCH
          Maintainer: Mangatan Team
          Description: Mangatan Server
           A robust manga server application.
          EOF
          
          cat > deb_pkg/usr/share/applications/mangatan.desktop <<EOF
          [Desktop Entry]
          Name=Mangatan
          Exec=/usr/bin/mangatan
          Icon=mangatan
          Type=Application
          Categories=Utility;
          Terminal=false
          EOF
          
          dpkg-deb --build deb_pkg output/mangatan_${CLEAN_VERSION}_${DEB_ARCH}.deb

          # --- 2. BUILD TAR.GZ ---
          mkdir -p tar_staging/mangatan-${CLEAN_VERSION}
          cp "$BINARY_PATH" tar_staging/mangatan-${CLEAN_VERSION}/mangatan
          chmod +x tar_staging/mangatan-${CLEAN_VERSION}/mangatan
          
          cd tar_staging
          tar -czvf ../output/mangatan-${{ matrix.arch_name }}.tar.gz mangatan-${CLEAN_VERSION}
          cd ..

      # --- MACOS PACKAGING ---
      - name: Package macOS
        if: runner.os == 'macOS'
        shell: bash
        run: |
          mkdir output
          cp target/${{ matrix.target }}/release/mangatan output/
          cd output && zip mangatan-macos.zip mangatan

      # --- UPLOAD ARTIFACTS ---
      - name: Upload Windows Artifact
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: mangatan-${{ matrix.arch_name }}
          path: final_artifact/mangatan-windows-x64.zip

      - name: Upload Linux Artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: mangatan-${{ matrix.arch_name }}
          path: output/*

      - name: Upload macOS Artifacts
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: mangatan-${{ matrix.arch_name }}
          path: output/mangatan-macos.zip

  # --- JOB 5: Release ---
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build_mangatan]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  

      - name: Download Linux x64
        uses: actions/download-artifact@v4
        with:
          name: mangatan-linux-x64
          path: release/linux-x64

      - name: Download Linux ARM64
        uses: actions/download-artifact@v4
        with:
          name: mangatan-linux-arm64
          path: release/linux-arm64
          
      - name: Download Windows
        uses: actions/download-artifact@v4
        with:
          name: mangatan-windows-x64
          path: release/windows
          
      - name: Download Mac Intel
        uses: actions/download-artifact@v4
        with:
          name: mangatan-macOS-x64
          path: release/mac-intel
          
      - name: Download Mac Silicon
        uses: actions/download-artifact@v4
        with:
          name: mangatan-macOS-arm64
          path: release/mac-silicon

      - name: Prepare Final Assets
        run: |
          mkdir final_release
          VERSION=${{ github.ref_name }}
          
          # WINDOWS
          mv release/windows/mangatan-windows-x64.zip final_release/Mangatan-${VERSION}-Windows-x64.zip
          
          # LINUX x64
          mv release/linux-x64/*.deb final_release/Mangatan-${VERSION}-Linux-x64.deb
          mv release/linux-x64/*.tar.gz final_release/Mangatan-${VERSION}-Linux-x64.tar.gz

          # LINUX ARM64
          mv release/linux-arm64/*.deb final_release/Mangatan-${VERSION}-Linux-arm64.deb
          mv release/linux-arm64/*.tar.gz final_release/Mangatan-${VERSION}-Linux-arm64.tar.gz
          
          # MACOS
          mv release/mac-intel/mangatan-macos.zip final_release/Mangatan-${VERSION}-macOS-Intel.zip
          mv release/mac-silicon/mangatan-macos.zip final_release/Mangatan-${VERSION}-macOS-Silicon.zip

      - name: Generate Checksums
        run: cd final_release && sha256sum * > Checksums.sha256

      - name: Generate Release Notes
        id: release_notes
        run: |
          CURRENT_TAG=${{ github.ref_name }}
          PREV_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || true)
          echo "## Release $CURRENT_TAG" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          if [ -z "$PREV_TAG" ]; then
            echo "### Initial Release" >> RELEASE_NOTES.md
            git log --no-merges --pretty=format:"- %s (%h)" >> RELEASE_NOTES.md
          else
            echo "### Changes since $PREV_TAG" >> RELEASE_NOTES.md
            git log "$PREV_TAG..$CURRENT_TAG" --no-merges --pretty=format:"- %s (%h)" >> RELEASE_NOTES.md
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: true
          body_path: RELEASE_NOTES.md
          files: final_release/*
