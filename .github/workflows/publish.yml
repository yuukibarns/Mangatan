name: CI Publish

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --- JOB 1: Compile Deno OCR Server ---
  build_ocr:
    name: Build OCR Binaries
    runs-on: ubuntu-20.04 # Use older distro for better compatibility
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v2.x

      - name: Compile OCR Server
        run: |
          mkdir -p ocr-server/dist
          cd ocr-server 
          deno compile --allow-net --allow-read --allow-write --allow-env --target x86_64-unknown-linux-gnu --output dist/ocr-server-linux server.ts
          deno compile --allow-net --allow-read --allow-write --allow-env --target x86_64-pc-windows-msvc --output dist/ocr-server-win.exe server.ts
          deno compile --allow-net --allow-read --allow-write --allow-env --target x86_64-apple-darwin --output dist/ocr-server-macos-x64 server.ts
          deno compile --allow-net --allow-read --allow-write --allow-env --target aarch64-apple-darwin --output dist/ocr-server-macos-arm64 server.ts

      - name: Upload OCR Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ocr-binaries
          path: ocr-server/dist/*

  # --- JOB 2: Build Custom JREs ---
jlink:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-20.04
            name: linux-x64
          - os: windows-latest
            name: windows-x64
          - os: macos-14
            name: macOS-arm64
          - os: macos-13
            name: macOS-x64
    steps:
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: 21 # SWITCHED TO LTS (25 is EA and breaks scanners)
          distribution: 'zulu'

      - name: Package JDK
        # Added: --bind-services, jdk.charsets, jdk.localedata
        run: jlink --add-modules java.base,java.compiler,java.datatransfer,java.desktop,java.instrument,java.logging,java.management,java.naming,java.prefs,java.scripting,java.se,java.security.jgss,java.security.sasl,java.sql,java.transaction.xa,java.xml,jdk.attach,jdk.crypto.ec,jdk.jdi,jdk.management,jdk.net,jdk.unsupported,jdk.unsupported.desktop,jdk.zipfs,jdk.accessibility,jdk.charsets,jdk.localedata --bind-services --output suwa --strip-debug --no-man-pages --no-header-files --compress=2

      - name: Upload JDK package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-jre
          path: suwa

  # --- JOB 3: Build Mangatan Launcher & Bundling ---
  build_mangatan:
    name: Build Mangatan (${{ matrix.name }})
    needs: [build_ocr, jlink]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux-x64
            # CRITICAL FIX: Build on Ubuntu 20.04 to support older GLIBC versions
            os: ubuntu-20.04
            target: x86_64-unknown-linux-gnu
            arch_name: linux-x64
            ocr_binary: ocr-server-linux
            
          - name: Windows-x64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            arch_name: windows-x64
            ocr_binary: ocr-server-win.exe
            
          - name: macOS-Intel
            os: macos-13
            target: x86_64-apple-darwin
            arch_name: macOS-x64
            ocr_binary: ocr-server-macos-x64
            
          - name: macOS-Silicon
            os: macos-14
            target: aarch64-apple-darwin
            arch_name: macOS-arm64
            ocr_binary: ocr-server-macos-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-dev libgtk-3-dev libappindicator3-dev librsvg2-dev libxdo-dev fuse

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      # --- ASSET PREPARATION ---
      - name: Create Resources Directory
        shell: bash
        run: mkdir -p bin/mangatan/resources

      - name: Download OCR Binaries
        uses: actions/download-artifact@v4
        with:
          name: ocr-binaries
          path: temp_ocr

      - name: Place OCR Binary
        shell: bash
        run: cp temp_ocr/${{ matrix.ocr_binary }} bin/mangatan/resources/

      - name: Download JRE
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.arch_name }}-jre
          path: temp_jre

      - name: Zip JRE for Embedding
        shell: bash
        run: |
          cd temp_jre
          if [ "${{ runner.os }}" == "Windows" ]; then
            7z a -tzip ../bin/mangatan/resources/jre_bundle.zip *
          else
            zip -r ../bin/mangatan/resources/jre_bundle.zip .
          fi

      - name: Download Suwayomi JAR
        shell: bash
        run: curl -L "https://github.com/Suwayomi/Suwayomi-Server-preview/releases/download/v2.1.2019/Suwayomi-Server-v2.1.2019.jar" -o bin/mangatan/resources/Suwayomi-Server.jar

      - name: Download and Setup WebUI
        shell: bash
        run: |
          curl -L "https://github.com/KolbyML/Suwayomi-WebUI/releases/download/v1.0.7/Suwayomi-WebUI-v1.0.7.zip" -o webui.zip
          mkdir webui_temp
          unzip webui.zip -d webui_temp
          mkdir -p bin/mangatan/resources/suwayomi-webui
          if [ $(ls -1 webui_temp | wc -l) -eq 1 ] && [ -d "webui_temp/$(ls webui_temp)" ]; then
            mv webui_temp/$(ls webui_temp)/* bin/mangatan/resources/suwayomi-webui/
          else
            mv webui_temp/* bin/mangatan/resources/suwayomi-webui/
          fi
          rm -rf webui_temp webui.zip

      # --- COMPILATION ---
      - name: Build Binary
        shell: bash
        env:
          CARGO_TARGET_DIR: ${{ github.workspace }}/target
        run: |
          cd bin/mangatan
          cargo build --release --target ${{ matrix.target }} --features embed-jre

      # --- WINDOWS PACKAGING (Mesa Fix Included) ---
      - name: Package Windows with Mesa
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir output
          cp target/${{ matrix.target }}/release/mangatan.exe output/
          
          echo "Fetching latest Mesa version..."
          MESA_TAG=$(curl -s https://api.github.com/repos/pal1000/mesa-dist-win/releases/latest | jq -r .tag_name)
          
          # Use CORRECTED URL for Mesa
          curl -L -o mesa.7z "https://github.com/pal1000/mesa-dist-win/releases/download/${MESA_TAG}/mesa3d-${MESA_TAG}-release-msvc.7z"
          
          7z x mesa.7z -omesa_dist
          
          echo "Copying Mesa DLLs..."
          cp mesa_dist/x64/opengl32.dll output/
          cp mesa_dist/x64/libgallium_wgl.dll output/
          if [ -f "mesa_dist/x64/d3d10warp.dll" ]; then
             cp mesa_dist/x64/d3d10warp.dll output/
          fi
          
          cd output
          7z a -tzip ../mangatan-windows-x64.zip *
          cd ..
          
          mkdir final_artifact
          mv mangatan-windows-x64.zip final_artifact/

      # --- LINUX PACKAGING (Fix Execv Error) ---
      - name: Package Linux (Deb & AppImage)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          BINARY_PATH="target/${{ matrix.target }}/release/mangatan"
          ICON_PATH="bin/mangatan/resources/faviconlogo.png"
          VERSION="${{ github.ref_name }}"
          CLEAN_VERSION=$(echo $VERSION | sed 's/^v//')
          
          mkdir -p output
          
          # --- DEB ---
          mkdir -p deb_pkg/usr/bin deb_pkg/usr/share/applications deb_pkg/usr/share/icons/hicolor/512x512/apps deb_pkg/DEBIAN
          cp "$BINARY_PATH" deb_pkg/usr/bin/mangatan
          cp "$ICON_PATH" deb_pkg/usr/share/icons/hicolor/512x512/apps/mangatan.png
          chmod +x deb_pkg/usr/bin/mangatan
          
          cat > deb_pkg/DEBIAN/control <<EOF
          Package: mangatan
          Version: $CLEAN_VERSION
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Mangatan Team
          Description: Mangatan Server
           A robust manga server application.
          EOF
          
          cat > deb_pkg/usr/share/applications/mangatan.desktop <<EOF
          [Desktop Entry]
          Name=Mangatan
          Exec=/usr/bin/mangatan
          Icon=mangatan
          Type=Application
          Categories=Utility;
          Terminal=false
          EOF
          
          dpkg-deb --build deb_pkg output/mangatan_${CLEAN_VERSION}_amd64.deb
          
          # --- APPIMAGE ---
          mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps
          
          # Copy files
          cp "$BINARY_PATH" AppDir/usr/bin/mangatan
          cp "$ICON_PATH" AppDir/mangatan.png
          cp "$ICON_PATH" AppDir/usr/share/icons/hicolor/256x256/apps/mangatan.png
          
          # Ensure Binary is Executable
          chmod +x AppDir/usr/bin/mangatan
          
          # Desktop File
          cat > AppDir/mangatan.desktop <<EOF
          [Desktop Entry]
          Name=Mangatan
          Exec=mangatan
          Icon=mangatan
          Type=Application
          Categories=Utility;
          Terminal=false
          EOF
          
          # Setup LinuxDeploy
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          
          # FIX: Explicitly tell linuxdeploy where the executable and desktop file are
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --executable AppDir/usr/bin/mangatan \
            --desktop-file AppDir/mangatan.desktop \
            --icon-file AppDir/mangatan.png \
            --output appimage
          
          mv Mangatan*.AppImage output/

      # --- MACOS PACKAGING ---
      - name: Package macOS (.app)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          BINARY_PATH="target/${{ matrix.target }}/release/mangatan"
          ICON_PATH="bin/mangatan/resources/faviconlogo.png"
          APP_NAME="Mangatan"
          BUNDLE_DIR="${APP_NAME}.app"
          
          mkdir -p output
          mkdir -p "$BUNDLE_DIR/Contents/MacOS" "$BUNDLE_DIR/Contents/Resources"
          cp "$BINARY_PATH" "$BUNDLE_DIR/Contents/MacOS/$APP_NAME"
          chmod +x "$BUNDLE_DIR/Contents/MacOS/$APP_NAME"
          
          cat > "$BUNDLE_DIR/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>$APP_NAME</string>
              <key>CFBundleIdentifier</key>
              <string>com.mangatan.server</string>
              <key>CFBundleName</key>
              <string>$APP_NAME</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSUIElement</key>
              <false/>
          </dict>
          </plist>
          EOF
          
          mkdir mangatan.iconset
          sips -z 16 16     "$ICON_PATH" --out mangatan.iconset/icon_16x16.png
          sips -z 32 32     "$ICON_PATH" --out mangatan.iconset/icon_16x16@2x.png
          sips -z 32 32     "$ICON_PATH" --out mangatan.iconset/icon_32x32.png
          sips -z 64 64     "$ICON_PATH" --out mangatan.iconset/icon_32x32@2x.png
          sips -z 128 128   "$ICON_PATH" --out mangatan.iconset/icon_128x128.png
          sips -z 256 256   "$ICON_PATH" --out mangatan.iconset/icon_128x128@2x.png
          sips -z 256 256   "$ICON_PATH" --out mangatan.iconset/icon_256x256.png
          sips -z 512 512   "$ICON_PATH" --out mangatan.iconset/icon_256x256@2x.png
          sips -z 512 512   "$ICON_PATH" --out mangatan.iconset/icon_512x512.png
          iconutil -c icns mangatan.iconset
          mv mangatan.icns "$BUNDLE_DIR/Contents/Resources/AppIcon.icns"
          
          zip -r "output/${APP_NAME}.app.zip" "$BUNDLE_DIR"

      # --- UPLOAD ARTIFACTS ---
      - name: Upload Windows Artifact
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: mangatan-${{ matrix.arch_name }}
          path: final_artifact/mangatan-windows-x64.zip

      - name: Upload Linux Artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: mangatan-${{ matrix.arch_name }}
          path: output/*

      - name: Upload macOS Artifacts
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: mangatan-${{ matrix.arch_name }}
          path: output/Mangatan.app.zip

  # --- JOB 4: Release ---
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build_mangatan]
    runs-on: ubuntu-latest
    steps:
      - name: Download Linux
        uses: actions/download-artifact@v4
        with:
          name: mangatan-linux-x64
          path: release/linux
          
      - name: Download Windows
        uses: actions/download-artifact@v4
        with:
          name: mangatan-windows-x64
          path: release/windows
          
      - name: Download Mac Intel
        uses: actions/download-artifact@v4
        with:
          name: mangatan-macOS-x64
          path: release/mac-intel
          
      - name: Download Mac Silicon
        uses: actions/download-artifact@v4
        with:
          name: mangatan-macOS-arm64
          path: release/mac-silicon

      - name: Prepare Final Assets
        run: |
          mkdir final_release
          VERSION=${{ github.ref_name }}
          
          # WINDOWS (Now a Zip)
          mv release/windows/mangatan-windows-x64.zip final_release/Mangatan-${VERSION}-Windows-x64.zip
          
          # LINUX
          mv release/linux/*.deb final_release/Mangatan-${VERSION}-Linux-x64.deb
          mv release/linux/*.AppImage final_release/Mangatan-${VERSION}-Linux-x64.AppImage
          
          # MACOS
          mv release/mac-intel/Mangatan.app.zip final_release/Mangatan-${VERSION}-macOS-Intel.app.zip
          mv release/mac-silicon/Mangatan.app.zip final_release/Mangatan-${VERSION}-macOS-Silicon.app.zip

      - name: Generate Checksums
        run: cd final_release && sha256sum * > Checksums.sha256

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: true
          files: final_release/*
