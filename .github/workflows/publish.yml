name: CI Publish

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --- JOB 1: Compile Deno OCR Server ---
  build_ocr:
    name: Build OCR Binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v2.x

      - name: Compile OCR Server
        run: |
          mkdir -p ocr-server/dist
          
          # Linux x64
          cd ocr-server && deno compile --allow-net --allow-read --allow-write --allow-env --target x86_64-unknown-linux-gnu --output dist/ocr-server-linux server.ts
          
          # Windows x64
          deno compile --allow-net --allow-read --allow-write --allow-env --target x86_64-pc-windows-msvc --output dist/ocr-server-win.exe server.ts
          
          # macOS Intel (x64)
          deno compile --allow-net --allow-read --allow-write --allow-env --target x86_64-apple-darwin --output dist/ocr-server-macos-x64 server.ts

          # macOS Apple Silicon (ARM64)
          deno compile --allow-net --allow-read --allow-write --allow-env --target aarch64-apple-darwin --output dist/ocr-server-macos-arm64 server.ts

      - name: Upload OCR Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ocr-binaries
          path: ocr-server/dist/*

  # --- JOB 2: Build Custom JREs (Required for embedding) ---
  jlink:
    name: Build JRE (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: linux-x64
          - os: windows-latest
            name: windows-x64
          - os: macos-13 # Intel Mac
            name: macOS-x64
          - os: macos-14 # ARM Mac (M1/M2)
            name: macOS-arm64
    steps:
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: 25
          distribution: 'zulu'

      - name: Create Custom Runtime Image
        run: jlink --add-modules java.base,java.compiler,java.datatransfer,java.desktop,java.instrument,java.logging,java.management,java.naming,java.prefs,java.scripting,java.se,java.security.jgss,java.security.sasl,java.sql,java.transaction.xa,java.xml,jdk.attach,jdk.crypto.ec,jdk.jdi,jdk.management,jdk.net,jdk.unsupported,jdk.unsupported.desktop,jdk.zipfs,jdk.accessibility --output suwa --strip-debug --no-man-pages --no-header-files --compress=2

      - name: Upload JRE
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-jre
          path: suwa

  # --- JOB 3: Build Mangatan Launcher (The All-in-One Binary) ---
  build_mangatan:
    name: Build Mangatan (${{ matrix.name }})
    needs: [build_ocr, jlink]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux-x64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary_name: mangatan
            jre_name: linux-x64
            ocr_binary: ocr-server-linux
            
          - name: Windows-x64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            binary_name: mangatan.exe
            jre_name: windows-x64
            ocr_binary: ocr-server-win.exe
            
          - name: macOS-Intel
            os: macos-13
            target: x86_64-apple-darwin
            binary_name: mangatan
            jre_name: macOS-x64
            ocr_binary: ocr-server-macos-x64
            
          - name: macOS-Silicon
            os: macos-14
            target: aarch64-apple-darwin
            binary_name: mangatan
            jre_name: macOS-arm64
            ocr_binary: ocr-server-macos-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # --- ASSET PREPARATION ---
      - name: Create Resources Directory
        shell: bash
        run: mkdir -p bin/mangatan/resources

      # 1. OCR Binary
      - name: Download OCR Binaries
        uses: actions/download-artifact@v4
        with:
          name: ocr-binaries
          path: temp_ocr

      - name: Place OCR Binary
        shell: bash
        run: cp temp_ocr/${{ matrix.ocr_binary }} bin/mangatan/resources/

      # 2. JRE Bundle
      - name: Download JRE
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.jre_name }}-jre
          path: temp_jre

      - name: Zip JRE for Embedding
        shell: bash
        run: |
          cd temp_jre
          # Cross-platform zip logic
          if [ "${{ runner.os }}" == "Windows" ]; then
            7z a -tzip ../bin/mangatan/resources/jre_bundle.zip *
          else
            zip -r ../bin/mangatan/resources/jre_bundle.zip .
          fi

      # 3. Suwayomi JAR (Specified URL)
      - name: Download Suwayomi JAR
        shell: bash
        run: |
          curl -L "https://github.com/Suwayomi/Suwayomi-Server-preview/releases/download/v2.1.2019/Suwayomi-Server-v2.1.2019.jar" -o bin/mangatan/resources/suwayomi-server.jar

# 4. WebUI (Robust Unzip)
      - name: Download and Setup WebUI
        shell: bash
        run: |
          # 1. Download
          curl -L "https://github.com/KolbyML/Suwayomi-WebUI/releases/download/v1.0.7/Suwayomi-WebUI-v1.0.7.zip" -o webui.zip
          
          # 2. Unzip to a temporary staging folder
          mkdir webui_temp
          unzip webui.zip -d webui_temp
          
          # 3. Create destination
          mkdir -p bin/mangatan/resources/suwayomi-webui

          # 4. Move files (Handle both Nested Folder and Flat Zip cases)
          # If the temp folder contains exactly one directory, move THAT directory's contents
          if [ $(ls -1 webui_temp | wc -l) -eq 1 ] && [ -d "webui_temp/$(ls webui_temp)" ]; then
            echo "Detected nested folder in zip. Moving contents..."
            mv webui_temp/$(ls webui_temp)/* bin/mangatan/resources/suwayomi-webui/
          else
            echo "Detected flat zip. Moving contents..."
            mv webui_temp/* bin/mangatan/resources/suwayomi-webui/
          fi

          # 5. Cleanup
          rm -rf webui_temp webui.zip

      # --- COMPILATION ---
      - name: Build Rust Binary
        shell: bash
        run: |
          cd bin/mangatan
          cargo build --release --target ${{ matrix.target }} --features embed-jre

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mangatan-${{ matrix.jre_name }}
          path: bin/mangatan/target/${{ matrix.target }}/release/${{ matrix.binary_name }}

  # --- JOB 4: Release ---
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build_mangatan]
    runs-on: ubuntu-latest
    steps:
      - name: Download Linux
        uses: actions/download-artifact@v4
        with:
          name: mangatan-linux-x64
          path: release/linux
          
      - name: Download Windows
        uses: actions/download-artifact@v4
        with:
          name: mangatan-windows-x64
          path: release/windows
          
      - name: Download Mac Intel
        uses: actions/download-artifact@v4
        with:
          name: mangatan-macOS-x64
          path: release/mac-intel
          
      - name: Download Mac Silicon
        uses: actions/download-artifact@v4
        with:
          name: mangatan-macOS-arm64
          path: release/mac-silicon

      - name: Prepare Assets
        run: |
          mkdir final_release
          mv release/linux/mangatan final_release/Mangatan-Linux-x64
          mv release/windows/mangatan.exe final_release/Mangatan-Windows-x64.exe
          mv release/mac-intel/mangatan final_release/Mangatan-macOS-Intel
          mv release/mac-silicon/mangatan final_release/Mangatan-macOS-Silicon
          
          # Make binaries executable (Linux/Mac)
          chmod +x final_release/Mangatan-Linux-x64
          chmod +x final_release/Mangatan-macOS-Intel
          chmod +x final_release/Mangatan-macOS-Silicon

      - name: Generate Checksums
        run: cd final_release && sha256sum * > Checksums.sha256

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: true
          files: final_release/*
